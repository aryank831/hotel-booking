<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Step 2 - Enter Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>

<body class="bg-gray-100 p-6">
  <div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-lg">
    <h2 class="text-2xl font-bold mb-4">Enter Your Details</h2>

    <div class="grid grid-cols-1 gap-4">
      <input type="text" id="name" class="border p-2 rounded" placeholder="Full Name" />
      <input type="tel" id="phone" class="border p-2 rounded" placeholder="Phone Number" />
      <input type="email" id="email" class="border p-2 rounded" placeholder="Email" />

      <div class="grid grid-cols-2 gap-4 mt-4">
        <button id="payNowBtn" class="bg-green-600 text-white py-2 rounded hover:bg-green-700">
          Pay Now
        </button>

        <button id="payLaterBtn" class="bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
          Pay on Check-in
        </button>
      </div>
    </div>
  </div>

  <!-- Firebase & Logic (modular SDK) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDsNCw7HCnfEEMtyk8D2USI0LFADF_9zGo",
      authDomain: "hotelbooking-f235e.firebaseapp.com",
      projectId: "hotelbooking-f235e",
      storageBucket: "hotelbooking-f235e.appspot.com",
      messagingSenderId: "279999958537",
      appId: "1:279999958537:web:043ba5a91b7dc1bdd372d8",
      measurementId: "G-FYRH8XDXYB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const bookingDetails = {
      checkin: params.get('checkin'),
      checkout: params.get('checkout'),
      roomType: params.get('roomType'),
      rooms: params.get('rooms'),
      guests: params.get('guests')
    };

    const validateInputs = () => {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const email = document.getElementById("email").value.trim();

      if (!name || !phone || !email) {
        alert("Please fill all details");
        return null;
      }

      const phoneRegex = /^[0-9]{10}$/;
      if (!phoneRegex.test(phone)) {
        alert("Please enter a valid 10-digit phone number.");
        return null;
      }

      return { name, phone, email };
    };

    const payNow = async () => {
      const customer = validateInputs();
      if (!customer) return;

      const bookingData = {
        ...bookingDetails,
        ...customer,
        paymentStatus: "Paid",
        timestamp: serverTimestamp()
      };

      console.log("Booking Data to be saved (Pay Now):", bookingData);

      const options = {
        key: "rzp_test_1234567890abcdef", // Replace with your real Razorpay test/live key
        amount: 10000, // â‚¹100
        currency: "INR",
        name: "Hotel MG Grand",
        description: "Hotel Booking",
        handler: async function (response) {
          try {
            console.log("Razorpay payment successful:", response);
            alert("Payment Successful! ID: " + response.razorpay_payment_id);

            bookingData.paymentId = response.razorpay_payment_id;

            // Save booking data to Firestore
            await addDoc(collection(db, "bookings"), bookingData);

            console.log("Booking saved to Firestore successfully.");
            window.location.href = "confirmation.html";
          } catch (error) {
            console.error("Error saving paid booking:", error.message);
            alert("Error saving booking. Try again.");
          }
        },
        prefill: customer,
        notes: bookingDetails,
        theme: { color: "#0f766e" }
      };

      const rzp = new Razorpay(options);
      rzp.open();
    };

    const payLater = async () => {
      const customer = validateInputs();
      if (!customer) return;

      const bookingData = {
        ...bookingDetails,
        ...customer,
        paymentStatus: "Pay on Check-in",
        timestamp: serverTimestamp()
      };

      console.log("Booking Data (Pay Later):", bookingData);

      try {
        // Save pay-later booking data to Firestore
        await addDoc(collection(db, "bookings"), bookingData);
        console.log("Booking saved to Firestore successfully.");
        alert("Booking saved! Please pay at check-in.");
        window.location.href = "confirmation.html";
      } catch (error) {
        console.error("Error saving pay-later booking:", error.message);
        alert("There was an issue saving your booking.");
      }
    };

    document.getElementById("payNowBtn").addEventListener("click", payNow);
    document.getElementById("payLaterBtn").addEventListener("click", payLater);
  </script>
</body>
</html>
